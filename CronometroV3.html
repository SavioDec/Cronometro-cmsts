<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 0;
      padding: 0;
      background: #f4f4f4;
    }

    /* overlay que cobre a tela e pisca em vermelho */
    #flash {
      position: fixed;
      inset: 0;
      background: red;
      opacity: 0;
      pointer-events: none;
      z-index: 9999;
    }

    @keyframes piscarVermelho {
      0%   { opacity: 0; }
      50%  { opacity: 0.6; }
      100% { opacity: 0; }
    }

    body.alerta #flash {
      animation: piscarVermelho 0.8s linear infinite;
    }

    /* Timer */
    .timer {
      font-size: 18.5em;
      display: flex;
      justify-content: center;
      margin: 20px 0;
    }

    .timer span {
      min-width: 200px;
      text-align: center;
    }

    /* Bot√µes */
    .botoes {
      margin: 10px 0;
    }

    .btn {
      font-size: 1.2em;
      padding: 10px 20px;
      margin: 5px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: 0.2s;
    }

    .btn:hover {
      filter: brightness(0.9);
    }

    .btn-primary { background: #007bff; color: white; }
    .btn-warning { background: #ffc107; color: black; }
    .btn-danger  { background: #dc3545; color: white; }
    .btn-info    { background: #0dcaf0; color: black; }
    .btn-secondary { background: #6c757d; color: white; }
  </style>
</head>
<body>

<div id="flash"></div>

<!-- Timer -->
<div class="timer">
  <span id="min">00:</span>
  <span id="seg">00</span>
</div>

<!-- Adicionar tempo -->
<div class="botoes">
  <button onclick="setSecondsFunction(300)" class="btn btn-primary">+ 5 minutos</button>
  <button onclick="setSecondsFunction(180)" class="btn btn-primary">+ 3 minutos</button>
  <button onclick="setSecondsFunction(60)" class="btn btn-primary">+ 1 minuto</button>
  <button onclick="setSecondsFunction(30)" class="btn btn-primary">+ 30 segundos</button>
</div>

<!-- Remover tempo -->
<div class="botoes">
  <button onclick="setSecondsFunction(-300)" class="btn btn-warning">- 5 minutos</button>
  <button onclick="setSecondsFunction(-180)" class="btn btn-warning">- 3 minutos</button>
  <button onclick="setSecondsFunction(-60)" class="btn btn-warning">- 1 minuto</button>
  <button onclick="setSecondsFunction(-30)" class="btn btn-warning">- 30 segundos</button>
</div>

<!-- Controles -->
<div class="botoes">
  <button onclick="stopFunction()" class="btn btn-danger">Parar</button>
  <button onclick="pauseFunction(0)" id="pause" class="btn btn-info">Pausar</button>
  <button onclick="pauseFunction(1)" id="continue" style="display: none" class="btn btn-info">Continuar</button>
  <button onclick="ensureAudio(); beep(250, 900, 0.25)" class="btn btn-secondary">Testar som</button>
</div>

<script>
var seconds = 0;
var minutes = 0;
var myVar;
var pausado = 0;
var audioCtx = null;

function ensureAudio() {
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
  if (audioCtx.state === 'suspended') {
    audioCtx.resume().catch(e => console.log("Audio resume failed:", e));
  }
}

function beep(duration = 200, frequency = 1000, volume = 0.2) {
  if (!audioCtx) return;
  try {
    const now = audioCtx.currentTime;
    const oscillator = audioCtx.createOscillator();
    const gainNode = audioCtx.createGain();

    oscillator.type = 'sine';
    oscillator.frequency.setValueAtTime(frequency, now);

    gainNode.gain.setValueAtTime(0.0, now);
    gainNode.gain.linearRampToValueAtTime(volume, now + 0.01);
    gainNode.gain.linearRampToValueAtTime(0.0, now + duration / 1000);

    oscillator.connect(gainNode);
    gainNode.connect(audioCtx.destination);

    oscillator.start(now);
    oscillator.stop(now + duration / 1000 + 0.02);
  } catch (err) {
    console.error("Erro ao tocar beep:", err);
  }
}

function setSecondsFunction(sec){
  ensureAudio();
  if ((sec < 0) && (minutes > 0)){
    seconds += minutes * 60;
    minutes = 0;
    seconds += sec;
  } else {
    seconds += sec;  
  }  
  clearInterval(myVar);
  myVar = setInterval(myTimer, 1000);
  myTimer();
}

function myTimer() {
  if (seconds >= 60){
    minutes += Math.floor(seconds/60);
    seconds = Math.round((seconds/60 - Math.floor(seconds/60))*60);    
  }

  document.getElementById("min").innerHTML = (minutes < 10 ? "0" : "") + minutes + ": ";
  document.getElementById("seg").innerHTML = (seconds < 10 ? "0" : "") + seconds;

  if (minutes > 0 && seconds == 0){
    minutes--;
    seconds = 60;
  }
  if ((minutes == 0 && seconds <= 0) || seconds < 0){
    stopFunction();
    return;
  }

  if (minutes === 0 && seconds < 10 && seconds >= 0 && pausado === 0){
    document.body.classList.add("alerta");
    beep(220, 1000, 0.22);
  } else {
    document.body.classList.remove("alerta");
  }

  if (pausado == 0){
    seconds -= 1;
  }    
}

function stopFunction() {
  clearInterval(myVar);  
  document.location.reload(true);  
}

function pauseFunction(valor) {  
  if (!(minutes == 0 && seconds == 0)){
    clearInterval(myVar);

    document.getElementById("min").innerHTML = (minutes < 10 ? "0" : "") + minutes + ": ";
    document.getElementById("seg").innerHTML = (seconds < 10 ? "0" : "") + seconds;

    switch (valor){
      case 0:
        document.getElementById("continue").style.display = "inline-block";
        document.getElementById("pause").style.display = "none";
        pausado = 1;
        document.body.classList.remove("alerta");
        break;
      case 1:
        document.getElementById("continue").style.display = "none";
        document.getElementById("pause").style.display = "inline-block";
        pausado = 0;
        setSecondsFunction(0);
        break;  
    }
  }  
}
</script>

</body>
</html>
